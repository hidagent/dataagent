# DataAgent 架构设计方案

## 第一章：概述与架构总览

### 1.1 项目背景

DataAgent 是基于 DeepAgent 构建的数据智能助手平台，支持三类用户：

| 用户类型 | 使用方式 | 主要功能 |
|---------|---------|---------|
| 数据开发工程师 | DataAgentCli (终端) | 数据开发、ETL 编写、SQL 调试 |
| 普通业务人员 | DataAgentChatUI (Web) | 数据查询、报告生成、数据分析 |
| 数据管理人员 | DataAgentChatUI (Web) | Skills 开发、知识维护、权限管理 |

### 1.2 设计目标

1. **代码复用**：将 deepagents_cli 中通用逻辑抽取为 DataAgentCore
2. **多端支持**：CLI 和 Web 端共享核心能力
3. **可扩展性**：支持自定义 Skills、Tools、MCP Server
4. **企业级特性**：会话管理、用户认证、权限控制

### 1.3 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              DataAgent 架构                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────┐         ┌─────────────────────────────────────────┐  │
│   │  DataAgentCli   │         │           DataAgentServer               │  │
│   │   (终端交互)     │         │            (FastAPI)                    │  │
│   │                 │         │                                         │  │
│   │  ┌───────────┐  │         │  ┌─────────────┐   ┌─────────────────┐ │  │
│   │  │ Terminal  │  │         │  │  REST API   │   │    WebSocket    │ │  │
│   │  │   HITL    │  │         │  │  /api/v1/*  │   │   /ws/chat/*    │ │  │
│   │  └───────────┘  │         │  └──────┬──────┘   └────────┬────────┘ │  │
│   └────────┬────────┘         │         │                   │          │  │
│            │                  │         │    HTTP/WebSocket │          │  │
│            │                  │         │         ▲         │          │  │
│            │                  │         │         │         │          │  │
│            │                  │         ▼         │         ▼          │  │
│            │                  │  ┌─────────────────────────────────┐   │  │
│            │                  │  │        Service Layer            │   │  │
│            │                  │  │  (ChatService, SessionService)  │   │  │
│            │                  │  └──────────────┬──────────────────┘   │  │
│            │                  └─────────────────┼───────────────────────┘  │
│            │                                    │                          │
│            │                                    │                          │
│            │         ┌──────────────────────────┘                          │
│            │         │                                                     │
│            ▼         ▼                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐ │
│   │                         DataAgentCore                                │ │
│   │                                                                      │ │
│   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │ │
│   │  │ AgentEngine  │  │  Middleware  │  │    Tools     │              │ │
│   │  │  (核心引擎)   │  │    Stack     │  │   Registry   │              │ │
│   │  └──────────────┘  └──────────────┘  └──────────────┘              │ │
│   │                                                                      │ │
│   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │ │
│   │  │   Memory     │  │    Skills    │  │   Sandbox    │              │ │
│   │  │   Manager    │  │    System    │  │   Manager    │              │ │
│   │  └──────────────┘  └──────────────┘  └──────────────┘              │ │
│   │                                                                      │ │
│   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │ │
│   │  │   Session    │  │     HITL     │  │    Config    │              │ │
│   │  │   Manager    │  │   Protocol   │  │   Manager    │              │ │
│   │  └──────────────┘  └──────────────┘  └──────────────┘              │ │
│   └─────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐ │
│   │                      External Dependencies                           │ │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │ │
│   │  │deepagents│  │LangChain │  │LangGraph │  │ Sandbox  │            │ │
│   │  │  (core)  │  │          │  │          │  │Providers │            │ │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │ │
│   └─────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘

                                    ▲
                                    │ HTTP/WebSocket
                                    │
                    ┌───────────────┴───────────────┐
                    │      DataAgentChatUI          │
                    │        (React Web)            │
                    │                               │
                    │  ┌─────────┐  ┌─────────┐    │
                    │  │  Chat   │  │  Admin  │    │
                    │  │  View   │  │  Panel  │    │
                    │  └─────────┘  └─────────┘    │
                    └───────────────────────────────┘
```

### 1.4 组件职责

| 组件 | 职责 | 技术栈 |
|------|------|--------|
| DataAgentCore | 核心业务逻辑，Agent 创建、执行、中间件 | Python, LangChain, LangGraph |
| DataAgentCli | 终端交互界面，命令行 HITL | Python, Rich, prompt-toolkit |
| DataAgentServer | Web API 服务，会话管理，用户认证 | Python, FastAPI, WebSocket |
| DataAgentChatUI | Web 前端界面 | React, TypeScript |

### 1.5 数据流

```
┌──────────────────────────────────────────────────────────────────────────┐
│                            CLI 数据流                                     │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  用户输入 ──► DataAgentCli ──► DataAgentCore ──► LLM                    │
│                   │                  │              │                    │
│                   │                  │              ▼                    │
│                   │                  │         Tool Calls                │
│                   │                  │              │                    │
│                   │                  ▼              ▼                    │
│                   │            HITL Request ◄── Execution                │
│                   │                  │                                   │
│                   ▼                  ▼                                   │
│            终端渲染 ◄────────── Events Stream                            │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                           Web 数据流                                      │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  DataAgentChatUI ──WebSocket──► DataAgentServer ──► DataAgentCore       │
│        │                              │                   │              │
│        │                              │                   ▼              │
│        │                              │              LLM + Tools         │
│        │                              │                   │              │
│        │                              ▼                   ▼              │
│        │                        HITL Request ◄──── Execution             │
│        │                              │                                  │
│        ▼                              ▼                                  │
│   UI 渲染 ◄────WebSocket────── Events Stream                             │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 1.6 项目结构

```
libs/
├── dataagent-core/          # 核心库
│   ├── pyproject.toml
│   └── dataagent_core/
│
├── dataagent-cli/           # CLI 客户端
│   ├── pyproject.toml
│   └── dataagent_cli/
│
├── dataagent-server/        # Web 服务端
│   ├── pyproject.toml
│   └── dataagent_server/
│
└── deepagents-cli/          # 原始项目 (保留，作为参考)
    └── deepagents_cli/
```

---

下一章：[02-deepagents-cli-analysis.md](./02-deepagents-cli-analysis.md) - deepagents_cli 可拆解性分析
