# GitLab CI/CD Pipeline for DataAgent
# 
# åŠŸèƒ½:
# 1. ä»£ç è´¨é‡æ£€æŸ¥ (lint, type check)
# 2. å•å…ƒæµ‹è¯•
# 3. è‡ªåŠ¨ç‰ˆæœ¬åˆ†æå’Œæ›´æ–°
# 4. è‡ªåŠ¨å‘å¸ƒ (å¯é€‰)

stages:
  - lint
  - test
  - version
  - release

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHON_VERSION: "3.12"

# ç¼“å­˜ pip ä¾èµ–
cache:
  paths:
    - .cache/pip/
    - .venv/

# åŸºç¡€ Python é•œåƒ
.python-base:
  image: python:${PYTHON_VERSION}
  before_script:
    - python -m pip install --upgrade pip
    - pip install -e source/dataagent-core
    - pip install -e source/dataagent-cli
    - pip install -e source/dataagent-server
    - pip install pytest ruff mypy

# ==================== Lint Stage ====================

lint:
  extends: .python-base
  stage: lint
  script:
    - ruff check source/
    - ruff format --check source/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Commit message æ ¼å¼æ£€æŸ¥
commit-lint:
  stage: lint
  image: python:${PYTHON_VERSION}
  script:
    - |
      # æ£€æŸ¥æœ€è¿‘çš„ commit message æ˜¯å¦ç¬¦åˆ Conventional Commits è§„èŒƒ
      COMMIT_MSG=$(git log -1 --pretty=%B)
      echo "Checking commit message: $COMMIT_MSG"
      
      # æ­£åˆ™åŒ¹é… Conventional Commits æ ¼å¼
      if echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?!?:"; then
        echo "âœ“ Commit message follows Conventional Commits format"
      else
        echo "âš  Warning: Commit message does not follow Conventional Commits format"
        echo ""
        echo "Expected format: <type>(<scope>): <description>"
        echo "Types: feat, fix, docs, style, refactor, perf, test, chore, ci, build"
        echo ""
        echo "Examples:"
        echo "  feat(server): add user authentication"
        echo "  fix(cli): resolve input parsing issue"
        echo "  docs: update README"
        # ä¸é˜»æ­¢ pipelineï¼Œåªæ˜¯è­¦å‘Š
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ==================== Test Stage ====================

test-core:
  extends: .python-base
  stage: test
  script:
    - pytest source/dataagent-core/tests -v --tb=short
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - changes:
        - source/dataagent-core/**/*

test-server:
  extends: .python-base
  stage: test
  script:
    - pytest source/dataagent-server/tests -v --tb=short
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - changes:
        - source/dataagent-server/**/*

test-cli:
  extends: .python-base
  stage: test
  script:
    - pytest source/dataagent-cli/tests -v --tb=short
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - changes:
        - source/dataagent-cli/**/*

# å¤šç§Ÿæˆ·éš”ç¦»æµ‹è¯•
test-isolation:
  extends: .python-base
  stage: test
  script:
    - pytest source/dataagent-server/tests/test_multi_tenant -v --tb=short
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ==================== Version Stage ====================

# åˆ†æç‰ˆæœ¬å˜æ›´ (MR æ—¶æ˜¾ç¤ºå»ºè®®)
version-analyze:
  stage: version
  image: python:${PYTHON_VERSION}
  script:
    - |
      echo "ğŸ“¦ Analyzing version changes..."
      
      # æ£€æŸ¥å„æ¨¡å—æ˜¯å¦æœ‰å˜æ›´
      for module in dataagent-core dataagent-cli dataagent-server dataagent-harbor; do
        MODULE_PATH="source/${module}"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --name-only origin/$CI_MERGE_REQUEST_TARGET_BRANCH...HEAD | grep -q "^${MODULE_PATH}/"; then
          echo ""
          echo "ğŸ” Changes detected in ${module}:"
          python scripts/version_manager.py analyze ${module} || true
        fi
      done
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

# è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬ (åˆå¹¶åˆ°ä¸»åˆ†æ”¯å)
version-bump:
  stage: version
  image: python:${PYTHON_VERSION}
  script:
    - |
      echo "ğŸ“¦ Auto-bumping versions based on commits..."
      
      # é…ç½® git
      git config user.email "ci@dataagent.local"
      git config user.name "DataAgent CI"
      
      CHANGED=false
      
      # æ£€æŸ¥å„æ¨¡å—
      for module in dataagent-core dataagent-cli dataagent-server dataagent-harbor; do
        MODULE_PATH="source/${module}"
        
        # æ£€æŸ¥æœ€è¿‘çš„ commit æ˜¯å¦æ¶‰åŠè¯¥æ¨¡å—
        if git diff --name-only HEAD~1 HEAD | grep -q "^${MODULE_PATH}/"; then
          echo ""
          echo "ğŸ”„ Processing ${module}..."
          python scripts/version_manager.py auto-bump ${module} && CHANGED=true || true
        fi
      done
      
      # å¦‚æœæœ‰ç‰ˆæœ¬å˜æ›´ï¼Œæäº¤
      if [ "$CHANGED" = true ]; then
        git add source/*/pyproject.toml
        git commit -m "chore: auto-bump versions [skip ci]" || echo "No changes to commit"
        git push origin HEAD:$CI_COMMIT_BRANCH || echo "Push failed or no changes"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: true

# ==================== Release Stage ====================

# åˆ›å»º Release (æ‰‹åŠ¨è§¦å‘)
release:
  stage: release
  image: python:${PYTHON_VERSION}
  script:
    - |
      echo "ğŸ“¦ Creating release..."
      python scripts/version_manager.py show-all
      
      # è¿™é‡Œå¯ä»¥æ·»åŠ :
      # - æ„å»º wheel åŒ…
      # - ä¸Šä¼ åˆ° PyPI æˆ–ç§æœ‰ä»“åº“
      # - åˆ›å»º GitLab Release
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: true
